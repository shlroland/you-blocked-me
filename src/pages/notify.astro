---
import Layout from '../layouts/Layout.astro'
---

<Layout>
  <main class="bg-furious-bg text-furious-text h-dvh overflow-hidden flex flex-col font-furious p-4">
    <div class="container mx-auto flex-1 flex flex-col justify-center min-h-0">
      <!-- Header -->
      <header class="text-center py-4 shrink-0">
        <div class="text-5xl mb-2">ğŸš—ğŸ’¢</div>
        <h1 class="text-2xl font-black uppercase tracking-tight text-furious-primary">ä½ æŒ¡ä½æˆ‘äº†ï¼</h1>
        <p class="text-xs opacity-60 mt-1">è¯·ç«‹å³æŒªè½¦</p>
      </header>

      <!-- Message Form -->
      <section class="flex-1 flex flex-col gap-3 max-w-2xl mx-auto w-full min-h-0 justify-center">
        <label class="flex flex-col min-h-0 shrink-0">
          <span class="text-sm font-bold uppercase tracking-wide opacity-80 mb-2 block shrink-0"> ğŸ“ ç•™è¨€ç»™è½¦ä¸» </span>
          <textarea
            id="message"
            class="w-full h-32 bg-white/10 border-2 border-furious-primary/50 text-furious-text p-4 text-base resize-none focus:outline-none focus:border-furious-primary placeholder:text-white/30 rounded-lg"
            placeholder="ä¾‹å¦‚ï¼šæ‚¨å¥½ï¼Œæ‚¨çš„è½¦æŒ¡ä½äº†æˆ‘çš„è½¦é“ï¼Œéº»çƒ¦å°½å¿«æŒªä¸€ä¸‹ï¼Œè°¢è°¢ï¼"></textarea>
        </label>

        <!-- Quick Messages -->
        <div class="flex flex-wrap gap-2 shrink-0">
          <button class="quick-msg bg-white/10 px-3 py-2 text-sm border border-white/20 hover:bg-white/20 transition-colors rounded-lg flex-1 text-center whitespace-nowrap"> ğŸš¨ ç´§æ€¥ï¼ </button>
          <button class="quick-msg bg-white/10 px-3 py-2 text-sm border border-white/20 hover:bg-white/20 transition-colors rounded-lg flex-1 text-center whitespace-nowrap"> ğŸ™ éº»çƒ¦æ‚¨äº† </button>
          <button class="quick-msg bg-white/10 px-3 py-2 text-sm border border-white/20 hover:bg-white/20 transition-colors rounded-lg flex-1 text-center whitespace-nowrap"> â° æˆ‘èµ¶æ—¶é—´ </button>
        </div>

        <!-- Location Map -->
        <div id="map-container" class="hidden mt-1 rounded-xl overflow-hidden border-2 border-furious-primary/30 h-64 shrink-0 relative transition-all duration-300">
          <iframe id="map-frame" class="w-full h-full border-0" title="Location Map"></iframe>
          <div class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1 rounded">å½“å‰ä½ç½®</div>
        </div>
      </section>

      <!-- Send Button -->
      <footer class="py-4 max-w-2xl mx-auto w-full shrink-0">
        <button
          id="sendBtn"
          class="w-full bg-furious-primary text-white font-black text-xl py-4 rounded-xl uppercase tracking-wider hover:bg-red-600 active:scale-95 transition-all shadow-lg shadow-furious-primary/30"
        >
          ğŸ“£ å‘é€é€šçŸ¥
        </button>
        <p class="text-center text-xs opacity-40 mt-3">ç‚¹å‡»åå°†ç«‹å³é€šçŸ¥è½¦ä¸»</p>
      </footer>
    </div>
  </main>
</Layout>

<script>
  import { wgs84ToGcj02 } from '../utils'

  // Quick message buttons
  document.querySelectorAll('.quick-msg').forEach((btn) => {
    btn.addEventListener('click', () => {
      const textarea = document.getElementById('message') as HTMLTextAreaElement
      const text = btn.textContent?.trim() || ''
      textarea.value = textarea.value ? `${textarea.value} ${text}` : text
      textarea.focus()
    })
  })

  // Send button
  document.getElementById('sendBtn')?.addEventListener('click', () => {
    const textarea = document.getElementById('message') as HTMLTextAreaElement
    const message = textarea.value.trim()

    if (!message) {
      alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹ ğŸ“')
      return
    }

    // TODO: Implement actual notification sending
    alert(`é€šçŸ¥å·²å‘é€ï¼ğŸš€\n\nç•™è¨€å†…å®¹ï¼š${message}`)
  })

  // Get location and show map
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords
        console.log('Latitude:', latitude)
        console.log('Longitude:', longitude)

        // Convert to GCJ-02 for Amap
        const gcj = wgs84ToGcj02(latitude, longitude)

        // Show map
        const mapContainer = document.getElementById('map-container')
        const mapFrame = document.getElementById('map-frame') as HTMLIFrameElement

        if (mapContainer && mapFrame) {
          // Using Amap URI API for a simple marker map
          // Note: This URL might prompt to open the app on mobile, or show a web view page.
          // For pure embedded view without app prompt interference, simple static maps are better but require a key.
          // The uri.amap.com/marker is a good fallback for interactive web view.
          mapFrame.src = `https://uri.amap.com/marker?position=${gcj.lng},${gcj.lat}&name=My%20Location&src=mypage&coordinate=gaode&callnative=0`
          mapContainer.classList.remove('hidden')
        }
      },
      (error) => {
        console.error('Error getting location:', error)
      },
      { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
    )
  } else {
    console.error('Geolocation is not supported by this browser.')
  }
</script>
