---
import Layout from '../layouts/Layout.astro'

// Get the notification key from URL query params
const url = new URL(Astro.request.url)
const notificationKey = url.searchParams.get('key') || 'demo-key'
---

<Layout>
  <main class="bg-calm-bg text-calm-text min-h-screen flex flex-col items-center justify-center font-calm p-4">
    <div class="container mx-auto flex items-center justify-center min-h-screen">
      <div class="bg-white rounded-calm-container shadow-sm p-12 max-w-lg w-full text-center">
        <div class="inline-block bg-calm-primary text-white rounded-full px-6 py-2 mb-8 text-sm font-medium tracking-wide">ğŸ“¬ æ”¶åˆ°é€šçŸ¥</div>

        <h1 class="text-4xl font-light text-slate-800 mb-6 tracking-wide">ä¸ç€æ€¥ã€‚</h1>

        <!-- Loading state -->
        <div id="loading" class="text-lg leading-relaxed mb-10 opacity-80">
          <div class="animate-pulse">æ­£åœ¨åŠ è½½é€šçŸ¥å†…å®¹...</div>
        </div>

        <!-- Message content (hidden initially) -->
        <div id="messageContent" class="hidden">
          <p id="messageText" class="text-lg leading-relaxed mb-10 opacity-80"></p>

          <button class="bg-calm-primary text-white text-lg font-medium py-4 px-10 rounded-calm-lg hover:opacity-90 transition-opacity w-full"> ç­‰ä¼šå„¿å†è¯´ </button>
        </div>

        <div class="mt-8 text-xs text-calm-text opacity-40">
          é€šçŸ¥ ID: <span id="notificationId" data-key={notificationKey}>{notificationKey}</span>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  // Simulate async KV fetch with setTimeout
  async function fetchNotificationMessage(key: string): Promise<string> {
    return new Promise((resolve) => {
      setTimeout(() => {
        // Mock data - in the future this will be fetched from KV storage
        const mockMessages: Record<string, string> = {
          'demo-key': 'æœ‰äººè¯´ä½ çš„è½¦æŒ¡ä½äº†ä»–ä»¬ã€‚æœ‰ç©ºçš„æ—¶å€™å¯ä»¥å»çœ‹çœ‹ï¼Œæˆ–è€…ä¸çœ‹ä¹Ÿè¡Œï¼Œéšæ„ã€‚',
          'urgent-001': 'ğŸš¨ ç´§æ€¥ï¼æ‚¨çš„è½¦ä¸¥é‡é˜»ç¢äº†äº¤é€šï¼Œè¯·ç«‹å³å¤„ç†ï¼',
          'polite-002': 'æ‚¨å¥½ï¼Œæ‚¨çš„è½¦æŒ¡ä½äº†æˆ‘çš„è½¦é“ï¼Œéº»çƒ¦å°½å¿«æŒªä¸€ä¸‹ï¼Œè°¢è°¢ï¼ğŸ™',
        }

        const message = mockMessages[key] || 'æœ‰äººé€šçŸ¥ä½ æŒªè½¦ï¼Œä½†æ²¡æœ‰ç•™ä¸‹å…·ä½“ä¿¡æ¯ã€‚'
        resolve(message)
      }, 1500) // Simulate 1.5s network delay
    })
  }

  // Load message on page load
  ;(async () => {
    try {
      // Get notification key from data attribute
      const notificationKeyElement = document.getElementById('notificationId')
      const notificationKey = notificationKeyElement?.getAttribute('data-key') || 'demo-key'

      const message = await fetchNotificationMessage(notificationKey)

      // Hide loading, show content
      const loadingEl = document.getElementById('loading')
      const contentEl = document.getElementById('messageContent')
      const messageEl = document.getElementById('messageText')

      if (loadingEl) loadingEl.classList.add('hidden')
      if (contentEl) contentEl.classList.remove('hidden')
      if (messageEl) messageEl.textContent = message
    } catch (error) {
      console.error('Failed to load notification:', error)
      const loadingEl = document.getElementById('loading')
      if (loadingEl) {
        loadingEl.innerHTML = '<div class="text-red-500">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>'
      }
    }
  })()
</script>
