# Agent Operational Guide (AGENTS.md)

This repository hosts a car-moving notification service built with **Effect-ts**, **Astro 5**, **React 19**, and **TailwindCSS 4**. It targets **Aliyun ESA** and **Cloudflare Workers**.

## 1. Environment & Commands

### Build & Deploy
- **Package Manager**: `pnpm` (Core)
- **Frontend Dev**: `pnpm dev` (Astro host)
- **Worker Dev (Cloudflare)**: `pnpm worker:dev:wrangler` (or `debug` for inspector)
- **Worker Dev (Aliyun)**: `pnpm worker:dev:esa`
- **Build (Aliyun)**: `pnpm build:esa`
- **Build (Cloudflare)**: `pnpm build:cf`

### Testing & Verification
- **Test Runner**: `vitest` (Implicitly available via `esa-cli` or `node_modules`).
  - Run all: `npx vitest run`
  - Run single: `npx vitest run path/to/file.test.ts`
  - **Note**: No tests currently exist. Create `*.test.ts` files adjacent to source.
- **Linting**: No explicit linter config found. Follow existing file patterns.

## 2. Code Architecture

### Directory Structure
- `src/functions/`: Backend business logic (Effect-ts).
  - `effect/movecar/`: Core domain logic (Services, RPCs).
  - `effect/adapator/`: Platform-specific adapters (ESA, Cloudflare).
- `src/components/`: React frontend components.
- `src/pages/`: Astro pages.
- `src/atoms/`: Effect-Atom state definitions.

### Tech Stack
- **Runtime**: Serverless (Edge Workers).
- **Core Logic**: `Effect-ts` (Structured Concurrency, Error Management).
- **UI**: React 19 (Actions, Hooks), Tailwind CSS 4.
- **State**: `@effect-atom/atom-react`.

## 3. Coding Standards

### General
- **Indentation**: 2 spaces.
- **Types**: Strict TypeScript. No `any`. Use `unknown` with refinement.

### Backend (Effect-ts)
- **Style**: Semicolons **REQUIRED** (Matches `src/functions/`).
- **Control Flow**: 
  - PREFER `Effect.gen` generators over `pipe()` chains for readability.
  - NEVER throw exceptions. Use `Effect.fail` or `Effect.die`.
- **Validation**: Use `@effect/schema` for all DTOs and API inputs.
- **Patterns**:
  - Use `Layer` for dependency injection.
  - Define services in `src/functions/effect/movecar/`.

```typescript
// Example: src/functions/effect/movecar/service.ts
import { Effect, Context } from "effect";

export class MyService extends Context.Tag("MyService")<
  MyService,
  { readonly notify: (id: string) => Effect.Effect<void, Error> }
>() {}
```

### Frontend (React)
- **Style**: Semicolons **OMITTED** (Matches `src/components/`).
- **Components**: Functional components with strict props.
- **State**: Use `useAtomSet` / `useAtomValue` for global state.
- **Async**: Use `useActionState` for form actions. Handle `Exit` types from Effect.
- **Styling**: Tailwind utility classes.
  - Use `className` prop.
  - Responsive prefixes: `short:`, `md:`, `lg:`.

```tsx
// Example: src/components/MyForm.tsx
import { useAtomSet } from '@effect-atom/atom-react'
import * as Exit from 'effect/Exit'

export default function MyForm() {
  const action = useAtomSet(myAtom)
  // ...
}
```

## 4. Agent Protocols

### ðŸ¤– Role: Sisyphus (Senior Engineer)
- **Philosophy**: "Work, delegate, verify, ship."
- **Delegation**:
  - **Visuals**: Delegate CSS/Layout tweaks to `frontend-ui-ux-engineer`.
  - **Docs**: Delegate README updates to `document-writer`.
  - **Research**: Use `librarian` for Effect-ts documentation lookups if unsure.

### ðŸ›‘ Critical Rules
1.  **Effect-First**: Solve problems using Effect primitives (`Effect.retry`, `Effect.timeout`), not native JS promises/timers.
2.  **Platform Agnostic**: Code in `src/functions/effect/` MUST be runtime-agnostic. Put Cloudflare/ESA specific logic in `adaptor/`.
3.  **Tests**: If you implement logic, you MUST create a test file to verify it using `vitest`.

## 5. Cursor/Copilot Rules

### Behavior
- **Refactoring**: When modifying Effect code, ensure `Effect.gen` is preserved/used.
- **Imports**: Group imports by library (`effect`, `react`, local).
- **Errors**: Always verify error channels in Effect types (e.g., `Effect<Success, Error, Requirements>`).

---
*Generated by Sisyphus on 2026-01-20*
